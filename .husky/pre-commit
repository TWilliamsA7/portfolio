#!/usr/bin/env bash
set -euo pipefail

# --- Terminal colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

echo -e "${YELLOW}--- Pre-commit: starting checks ---${NC}"

# 1) Run lint-staged (this will run eslint/prettier on staged files and re-stage fixes)
echo -e "${YELLOW}-- Running lint-staged ---${NC}"
if ! npx --no -- lint-staged; then
  echo -e "${RED}lint-staged failed. Fix issues then try again.${NC}"
  exit 1
fi

# Collect staged files (A = added, C = copied, M = modified)
mapfile -d '' STAGED < <(git diff --cached --name-only --diff-filter=ACM -z)

# If nothing staged, just exit success.
if [ ${#STAGED[@]} -eq 0 ]; then
  echo -e "${YELLOW}No staged files to check.${NC}"
  echo -e "${GREEN}Pre-commit completed successfully.${NC}"
  exit 0
fi

# --- Automatic Formatting and File Cleanup (safe) ---
echo -e "${YELLOW}--- Running safe auto-fixes (trailing whitespace only on text files) ---${NC}"

# We'll only edit text files to avoid corrupting images/binaries.
MODIFIED_FILES=()
for file in "${STAGED[@]}"; do
  # skip deleted files and directories
  [ -f "$file" ] || continue

  # Treat file as text only if grep -Iq succeeds (common cross-platform test)
  if grep -Iq . "$file"; then
    # Remove trailing whitespace from each line.
    if command -v perl >/dev/null 2>&1; then
      # Perl: supports multi-line and portable
      perl -0777 -pe 's/[ \t]+$//mg' -i -- "$file"
    else
      # Fallback: sed. On some platforms sed -i needs an argument; using -i '' would fail on Linux,
      # but git bash / mingw cope. We attempt the POSIX-compatible -i if present.
      sed -i -E 's/[[:space:]]+$//' "$file" || sed -i '' -E 's/[[:space:]]+$//' "$file" || true
    fi

    # If file changed on disk vs index, re-stage it
    if ! git diff --quiet -- "$file"; then
      git add -- "$file"
      MODIFIED_FILES+=("$file")
    fi
  else
    # Binary â€” skip
    :
  fi
done

if [ ${#MODIFIED_FILES[@]} -gt 0 ]; then
  echo -e "${GREEN}Auto-fixes applied and re-staged:${NC}"
  for f in "${MODIFIED_FILES[@]}"; do
    echo "  - $f"
  done
else
  echo -e "${GREEN}No auto-fixes needed.${NC}"
fi

# --- Console log check (optional) ---
# NOTE: prefer to rely on ESLint 'no-console' rule; this is a lightweight fallback.
echo -e "${YELLOW}--- Running simple console.* detection (index) ---${NC}"
FORBIDDEN_CONSOLE='console\.(log|info|warn|error|dir|clear|table)'

JS_TS_FILES=$(printf "%s\n" "${STAGED[@]}" | grep -E '\.(js|jsx|ts|tsx)$' || true)
if [ -n "$JS_TS_FILES" ]; then
  # Use git grep against the index (cached).
  # git grep --cached prints matches from the index.
  if git grep -n --cached -E "$FORBIDDEN_CONSOLE" -- $(printf "%s " $JS_TS_FILES) >/tmp/precommit-console-matches || true; then
    # Filter out obvious single-line // comments crudely (eslint will be better)
    # Show matches to user and abort
    if [ -s /tmp/precommit-console-matches ]; then
      echo -e "${RED}COMMIT ABORTED: Found console.* statements in staged files:${NC}"
      cat /tmp/precommit-console-matches
      rm -f /tmp/precommit-console-matches
      exit 1
    fi
    rm -f /tmp/precommit-console-matches
  fi
fi

# --- Merge conflict markers check ---
echo -e "${YELLOW}--- Running merge conflict markers check ---${NC}"
FOUND_CONFLICT=0
for file in "${STAGED[@]}"; do
  [ -f "$file" ] || continue
  # only check text files to avoid false positives on binary files
  if grep -Iq . "$file"; then
    if grep -En '^(<<<<<<<|=======|>>>>>>>)' "$file" >/dev/null 2>&1; then
      echo -e "${RED}COMMIT ABORTED: Merge conflict marker found in: $file${NC}"
      FOUND_CONFLICT=1
    fi
  fi
done
if [ $FOUND_CONFLICT -eq 1 ]; then
  exit 1
fi

# --- Basic secret detection (file name based) ---
echo -e "${YELLOW}--- Running basic sensitive filename check ---${NC}"
SENSITIVE_PATTERNS='(^|/)\.env$|(^|/)\.env\..*|\.pem$|\.key$|\.secret$|\.kdbx$'
# Check only newly added files in the index
ADDED_FILES=$(git diff --cached --name-only --diff-filter=A -z | tr '\0' '\n' || true)
for file in $ADDED_FILES; do
  if echo "$file" | grep -Eqi "$SENSITIVE_PATTERNS"; then
    echo -e "${RED}COMMIT ABORTED: Attempting to add potentially sensitive file: $file${NC}"
    echo -e "Please add it to .gitignore or remove it from the commit."
    exit 1
  fi
done

echo -e "${GREEN}--- Pre-commit checks passed ---${NC}"
exit 0
